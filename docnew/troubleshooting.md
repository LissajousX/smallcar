# 常见问题与排查指南

本篇汇总在搭建和使用 SmallCar 时容易遇到的一些问题，以及推荐的排查思路。尽量用“先检查什么、再看哪里代码/文档”的方式来组织。

---

## 1. 打不开网页 / 无法访问小车

### 1.1 AP 热点模式下访问失败

**现象**：

- 手机/电脑已经连到小车热点（如 `SmallCar-XXXX`），但：
  - `http://192.168.4.1/` 打不开；
  - `http://192.168.4.1/setup.html` 也访问失败。

**排查步骤**：

1. **确认 ESP32‑CAM 是否上电**：
   - 板载电源灯是否亮；
   - 若有串口日志，请观察是否有重启/异常输出。
2. **确认 Wi‑Fi 连接是否真的成功**：
   - 在手机/电脑 Wi‑Fi 列表中，确认当前连接的是小车 AP；
   - 若提示“无互联网”，这是正常的（AP 仅用于本地配置）。
3. **尝试直接访问 IP**：
   - 在浏览器地址栏输入完整的 `http://192.168.4.1/`（不要省略 `http://`）。
4. **仍失败时**：
   - 尝试重新刷写 ESP32 product 固件（见 `esp32_firmware.md`）；
   - 检查是否曾修改过 `app_httpd.cpp` 的 `/` 或 `/setup.html` handler。

### 1.2 家庭 Wi‑Fi 模式下访问失败

**现象**：

- 在 setup 页面里已经配置了家庭 Wi‑Fi；
- 提示已连接，但在家庭网络中无法通过 IP 或 `.local` 域名访问小车。

**排查步骤**：

1. **在 setup 页面查看状态**：
   - `sta_configured` 是否为 true；
   - `sta_connected` 是否为 true；
   - 是否显示了 `sta_ip`（如 `192.168.31.x`）。
2. **优先使用 IP 访问**：
   - 直接访问 `http://<sta_ip>/`；
   - 不要依赖 `smallcar-XXXX.local`（mDNS 在部分环境下不可靠）。
3. **在同一局域网中 ping 该 IP**：
   - 若 ping 不通，排查路由器是否开启了 AP 隔离、客户端隔离等。
4. **必要时查看 ESP32 串口日志**：
   - 是否频繁重连 Wi‑Fi；
   - 是否报错（如 DHCP 失败）。

---

## 2. 视频没有画面 / 非常卡

**现象**：

- 控制面板加载完成，但视频区域是黑的或一直在 loading；
- 画面延迟巨大。

**排查步骤**：

1. **检查视频流地址**：
   - 顶部“视频流地址”是否为类似：`http://<车IP>:81/stream`；
   - 若为空或格式错误，`main.js` 无法构造正确的 `/capture` 和 `/control` 地址。
2. **在浏览器 Network 里看 `:81/stream` 请求**：
   - 状态码是否为 200；
   - 是否被浏览器安全策略拦截（混合内容 / CORS）。
3. **确认网络质量**：
   - 若通过家庭 Wi‑Fi + 路由器再转发，链路较长、干扰较多时画面会更卡；
   - 可以在 `panel-advanced` 中调低分辨率或帧率（geek 模式下）。

---

## 3. 控制有延迟或偶尔失灵

**现象**：

- 点击前进/转向按钮，小车响应有明显延迟；
- 偶尔部分指令“丢失”。

**排查步骤**：

1. **检查 WebSocket 状态**：
   - 浏览器控制台内是否有 WebSocket 断开/重连日志；
   - 若频繁重连，优先排查 Wi‑Fi 信号与网络质量。
2. **在 ESP32 串口日志中查看接收情况**：
   - 每条 JSON 命令是否都被解析并打印；
3. **查看 STM32 串口解析逻辑**：
   - `main.c` 中的 UART 接收缓存是否足够；
   - 是否在大负载/长时间运行后出现溢出或异常分支。

---

## 4. 电池电量显示不对劲

**现象**：

- 电量百分比与实际感觉不符；
- 或长期处于 100% / 0%。

**排查步骤**：

1. **用万用表测量实际电池电压**：
   - 与 Web 前端显示的 `mv`（`/battery` 返回）对比；
   - 若差距过大，怀疑分压电阻或 ADC 基准值设置问题。
2. **检查 STM32 中的电压/百分比宏**：
   - `battery.c` 中 `BAT_FULL_MV`、`BAT_EMPTY_MV` 是否与你的电池相符；
   - 若你已经手动调过这些值，确认是否重新编译并刷写了 STM32 固件。
3. **前端百分比算法**：
   - `web/main.js` 中 `computeBatteryPercentFromMv` 使用的区间（例如 10.5V~12.3V）是否符合预期；
   - 如需调整，只改前端即可，无需动固件。

---

## 5. OTA 升级失败

### 5.1 本地文件升级失败

**现象**：

- 选择 `.bin` 文件后点击“本地文件升级”，提示失败或没有反应。

**排查步骤**：

1. **确认视频流地址已填写**：
   - OTA 逻辑会根据视频 URL 推导出 `/ota`，若为空则无法构造正确地址；
2. **确认固件文件正确**：
   - 是否为针对 ESP32‑CAM 构建的 `.bin`；
   - 是否没有被浏览器或系统拦截（部分浏览器对本地文件有权限限制）。
3. **在网络面板中查看 `/ota` 请求**：
   - 是否实际发出；
   - 返回状态码和错误信息。

### 5.2 从路由器一键升级失败

**排查步骤**：

1. **确认路由器地址**：
   - `router-base` 或 `DEFAULT_ROUTER_BASE` 是否指向正确的 iStoreOS/runner‑web 服务；
2. **确认固件文件存在**：
   - 路径是否有：
     - `/firmware/geek/esp32cam-latest.bin`
     - `/firmware/product/esp32cam-product-latest.bin`
3. **检查路由器的 HTTP 日志 / Nginx 日志**：
   - 是否有 404 / 403 / 500 等错误。

---

## 6. 版本号 / version.txt 不对

**现象**：

- 页面标题或左上角显示的版本号与实际不符；
- 访问 `/version.txt` 报 404 或内容老旧。

**排查步骤**：

1. **确认 `web/version.txt` 是否更新**；
2. **product 模式下重新打包前端**：
   - 运行 `python esp32_cam/CameraWebServer/tools/embed_product_frontend.py`；
   - 再重新构建并刷写 `esp32cam_product` 固件；
3. **确认 `app_httpd.cpp` 中 `/version.txt` handler 存在且被注册**。

---

## 7. 我不知道从哪里读代码

如果你只是“想改一点行为”但不知道从哪里入手，可以按下面顺序：

- Web UI / 交互相关 → `web/main.js`、`web/index.html`；
- Wi‑Fi / OTA / 电池 JSON 接口 → `esp32_cam/CameraWebServer/app_httpd.cpp` + `CameraWebServer.ino`；
- 电机/舵机控制、电池采样、低电保护 → `smallcar_keil/main.c` + `battery.c`；
- 路由器/iStoreOS 部署与固件仓库 → `docnew/web_frontend.md`、`docnew/ota_and_update.md`。

---

## 8. 还解决不了怎么办？

- 准备好这些信息再求助会更高效：
  - 你现在使用的是 product 还是 geek 固件；
  - ESP32 与 STM32 的构建时间/版本；
  - 浏览器控制台中是否有报错；
  - 是否能 ping 通小车 IP；
  - 相关接口（`/status`、`/battery`、`/wifi_state`、`/ota` 等）的 HTTP 状态码和返回内容；
- 可以在 Issue / 群组中附上日志和截图，方便他人一起排查。
