# STM32 四轮差速遥控小车（smallcar）

基于 **STM32F103C8T6** + **TB6612FNG** 四轮差速驱动 + **PS2 无线手柄** 的遥控小车工程。

当前工程主要使用 **Keil µVision5 + ARMCC V5** 开发，底层采用直接寄存器配置方式，实现：

- 四轮差速电机控制（左右两侧并联驱动）
- PS2 无线手柄解码（GPIO bit-bang SPI）
- 多挡位速度控制
- D-Pad 离散动作 + 左摇杆连续差速控制
- 右摇杆控制的 **双舵机云台**（摄像头俯仰/左右）

后续可扩展为：搭载树莓派实现 WebRTC 实时视频/语音 + 网络遥控。

---

## 1. 仓库结构

```text
smallcar/
├─ ps2.md                      # PS2 手柄协议与时序说明
├─ .gitignore                  # Git 忽略规则
├─ README.md                   # 本项目说明
│
├─ example/                    # 参考示例工程（PS2 + 四轮差速遥控，来自示例代码）
│   └─ ...
│
├─ smallcar_f103/              # 早期 STM32CubeIDE 工程（未继续使用）
│   └─ .metadata, *.ioc 等
│
├─ smallcar_f103_1/            # 另一份 CubeIDE 工程草稿
│   └─ smallcar_f103_1.ioc
│
└─ smallcar_keil/              # **当前主工程（Keil µVision5）**
    ├─ main.c                  # 主循环和 PS2 控制逻辑
    ├─ motor.c / motor.h       # 电机驱动（TB6612 + TIM3 PWM）
    ├─ ps2.c / ps2.h           # PS2 手柄 GPIO SPI 驱动与按键/摇杆解析
    ├─ servo.c / servo.h       # 双舵机云台控制（TIM2_CH1/CH2）
    ├─ pins.md                 # STM32 引脚定义文档
    ├─ smallcar_keil.uvprojx   # Keil 工程文件（必需）
    ├─ smallcar_keil.uvoptx    # Keil 选项文件
    └─ RTE/Device/...          # CMSIS/Startup/System 文件
```

实际开发/编译主要使用 `smallcar_keil` 目录。

---

## 2. 硬件组成

- **主控 MCU**：STM32F103C8T6
- **电机驱动**：TB6612FNG
  - 左侧两轮并联为“左轮”；右侧两轮并联为“右轮”
- **电机**：4× 直流电机
- **遥控器**：PS2 无线手柄（须支持模拟模式）
- **舵机**：2× 9g/12g 舵机（如 SG90/MG90S），组成摄像头云台：
  - 舵机 1：水平 Yaw
  - 舵机 2：俯仰 Pitch
- **电源建议**：
  - 电机电源（TB6612 VM）：如 7.4V/11.1V 电池
  - 逻辑电源（STM32、TB6612 VCC、PS2 接收端）：5V/3.3V
  - 舵机电源：单独 5V ≥2A 模块
  - **所有 GND 共地**

详细引脚定义见 `smallcar_keil/pins.md`。

---

## 3. 引脚概览（简要）

完整表格请看 `smallcar_keil/pins.md`，这里给一个简要概览：

### 3.1 电机 + TB6612FNG

- STBY：PA3
- 左轮 PWM：PB0（TIM3_CH3）
- 右轮 PWM：PB1（TIM3_CH4）
- 左轮方向：PB12（AIN1）、PB13（AIN2）
- 右轮方向：PB14（BIN1）、PB15（BIN2）

### 3.2 PS2 无线手柄（GPIO SPI）

- ATT/SEL (CS)：PA4
- CLK：PA5
- DATA (DI)：PA6（上拉输入）
- CMD (DO)：PA7

### 3.3 双舵机云台

- 云台水平 Yaw：PA0（TIM2_CH1）
- 云台俯仰 Pitch：PA1（TIM2_CH2）

---

## 4. 开发环境

- IDE：Keil µVision 5
- 编译器：ARMCC V5.06 (ARM-ADS)
- 设备包：`Keil.STM32F1xx_DFP.2.4.0`
- 启动与系统：RTE 内自动生成的 `startup_stm32f10x_md.s`、`system_stm32f10x.c`
- 不使用 HAL，采用寄存器直接配置 GPIO、TIM3、TIM2 等外设。

打开工程：

1. 启动 Keil µVision。
2. 打开 `smallcar_keil/smallcar_keil.uvprojx`。
3. 确认 Target 设备为 `STM32F103C8`。
4. 点击 Build，编译工程；使用 ST-LINK 等下载到目标板。

---

## 5. 控制逻辑说明

### 5.1 速度挡位（PS2 彩色按钮）

在 `main.c` 中，使用 **彩色按钮** 选择速度挡位，内部变量 `speed_percent` 取值：

- □（PINK，左方块）：`speed_percent = 50`（慢速）
- ×（BLUE，叉号）：`speed_percent = 70`（中速）
- ○（RED，圆圈）：`speed_percent = 85`（快速）
- △（GREEN，三角）：`speed_percent = 100`（最高速）

挡位会同时影响：

- 离散动作（方向键 + L1/R1）
- 左摇杆差速连续控制

### 5.2 方向键 + L1/R1（离散动作，优先级最高）

当 D-Pad 有按键时，**忽略左摇杆**，优先执行离散动作：

- 基本动作：
  - `↑`：直线前进
  - `↓`：直线后退
  - `←`：原地左转
  - `→`：原地右转

- 弯道前进/后退（L1 / R1 + 上/下）：
  - `L1 + ↑`：左转前进（左轮慢，右轮快）
  - `L1 + ↓`：左转后退
  - `R1 + ↑`：右转前进（右轮慢，左轮快）
  - `R1 + ↓`：右转后退

代码中通过 `base = speed_percent`，并设置内侧轮约为 `base * 40%`，外侧轮 `base`，实现弯道效果。

### 5.3 左摇杆：差速连续控制（仅红灯模拟模式）

当没有任何方向键按下时，才启用左摇杆控制：

- 仅当 `Data[1] == 0x73`（手柄红灯模拟模式）时，才使用摇杆值；否则强制电机停止，避免上电乱跑。
- 将摇杆值转换为偏移：
  - `vx = LX - 0x80`（右为正，左为负）
  - `vy = 0x80 - LY`（上为正，下为负）
- 设置死区：
  - `-20 < vx < 20` 视为 0
  - `-20 < vy < 20` 视为 0
- 归一化到约 `[-100, 100]`：
  - `vx = vx * 100 / 128`
  - `vy = vy * 100 / 128`
- 差速混合：
  - `left = vy - k_turn * vx / 100`
  - `right = vy + k_turn * vx / 100`
  - 其中 `k_turn = 70`（转向敏感度，可调）
- 限幅后再乘以 `speed_percent`，最终传入 `Motor_SetLR(left_cmd, right_cmd)`。

效果：

- 左摇杆前后控制速度，左右控制转弯，形成类似“遥控车摇杆”的连续控制方式。
- 挡位会整体缩放速度，方便在室内/狭小空间低速调试。

### 5.4 右摇杆：双舵机云台控制

右摇杆用于控制摄像头云台的 **水平旋转** 和 **俯仰角度**：

- 从 PS2 读取：
  - `rx = ps2_get_anolog_data(PSS_RX);`
  - `ry = ps2_get_anolog_data(PSS_RY);`

- 映射到角度（可根据实际舵机和云台机构微调）：
  - 水平 Yaw：
    - `rx ∈ [0, 255]` → `yaw_angle ∈ [30°, 150°]`
  - 俯仰 Pitch：
    - `ry ∈ [0, 255]` → `pitch_angle ∈ [45°, 135°]`，
    - 上推摇杆（`ry` 小）对应抬头（角度大）。

- 调用舵机接口：
  - `Servo_SetYawAngle(yaw_angle);`
  - `Servo_SetPitchAngle(pitch_angle);`

舵机底层使用 `TIM2` 产生 50Hz PWM，1.0ms~2.0ms 脉宽对应 0°~180°。

---

## 6. 安全行为与上电注意事项

- 上电后，如 PS2 手柄未处于 **红灯模拟模式**（`Data[1] != 0x73`），左摇杆控制被禁用，电机保持停止，避免上电乱动。
- 方向键优先级高于摇杆，保证在任何时候按 D-Pad 都能立即得到确定动作（紧急停车/转向）。
- 舵机供电建议使用独立 5V 大电流电源并与 STM32 共地，避免舵机大电流干扰 MCU 复位。

---

## 7. 使用步骤（快速上手）

1. 硬件按 `pins.md` 接好：
   - STM32 ↔ TB6612 ↔ 电机
   - STM32 PA4~PA7 ↔ PS2 接收端
   - STM32 PA0/PA1 ↔ 两个舵机
   - 确保所有模块 GND 共地

2. 打开 Keil 工程 `smallcar_keil.uvprojx`，编译并下载到 STM32F103C8T6。

3. 打开 PS2 手柄，切换到 **红灯模拟模式**（一般按 MODE 键切换）。

4. 测试：
   - 使用彩色按钮切换速度挡位；
   - 用方向键测试前进/后退/原地转向；
   - 用 L1/R1 + 上/下 测试弯道前进/后退；
   - 松开方向键后，用左摇杆进行连续差速控制；
   - 用右摇杆控制摄像头云台左右/俯仰。

---

## 8. 后续扩展方向（建议）

目前工程已具备较完整的底层驱动和遥控逻辑，可在此基础上继续扩展：

- 在小车上搭载树莓派：
  - 采集摄像头视频 + 麦克风音频
  - 通过 WebRTC 在局域网内实现实时视频/语音 + 浏览器遥控
- 通过串口连接树莓派与 STM32：
  - 树莓派作为“上位机”，浏览器控制 → 树莓派 → 串口 → STM32 执行动作
- 补充文档：
  - 电源设计说明、电池选择、机械结构（云台固定方式等）

---

## 9. 许可协议

本项目采用 **MIT License** 开源协议发布。

- 你可以自由地使用、复制、修改、合并、出版、分发本项目代码，甚至用于商业用途；
- 唯一要求是在所有副本或重要部分中保留原始的版权声明和许可声明；
- 本项目代码按“现状（AS IS）”提供，不提供任何形式的担保，作者不对任何使用造成的损失负责。

详细条款请参见仓库根目录的 `LICENSE` 文件（MIT License 原文）。
