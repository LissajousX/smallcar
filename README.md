# STM32 四轮差速遥控小车（smallcar）

基于 **STM32F103C8T6** + **TB6612FNG** 四轮差速驱动 + **PS2 无线手柄** 的遥控小车工程。

当前工程主要使用 **Keil µVision5 + ARMCC V5** 开发，底层采用直接寄存器配置方式，实现：

- 四轮差速电机控制（左右两侧并联驱动）
- PS2 无线手柄解码（GPIO bit-bang SPI）
- 多挡位速度控制（SELECT 三挡循环：60% / 80% / 100%，默认 80%）
- R1/R2 为前进/后退油门，L1/L2 为原地左右旋转
- 左右方向键 + 左摇杆 X 做差速转弯，上下方向保留扩展
- 彩色键 + 右摇杆 控制 **双舵机云台**（摄像头俯仰/左右），支持步进 + 模拟微调

后续可扩展为：搭载树莓派实现 WebRTC 实时视频/语音 + 网络遥控。

---

## 1. 仓库结构

```text
smallcar/
├─ doc/                        # 文档：协议、键位映射、引脚等
│   ├─ ps2_protocol.md         # PS2 手柄协议与 STM32 接线/时序说明
│   ├─ ps2_keymap.md           # PS2 键位与控制映射 + Data[] 实测
│   └─ pins.md                 # 引脚定义汇总（电机/PS2/云台）
├─ .gitignore                  # Git 忽略规则
├─ README.md                   # 本项目说明
└─ smallcar_keil/              # **当前主工程（Keil µVision5）**
    ├─ main.c                  # 主循环和 PS2 控制逻辑
    ├─ motor.c / motor.h       # 电机驱动（TB6612 + TIM3 PWM）
    ├─ ps2.c / ps2.h           # PS2 手柄 GPIO SPI 驱动与按键/摇杆解析
    ├─ servo.c / servo.h       # 双舵机云台控制（TIM2_CH1/CH2）
    ├─ pins.md                 # 工程目录内的引脚说明（与 doc/pins.md 内容相同）
    ├─ smallcar_keil.uvprojx   # Keil 工程文件（必需）
    ├─ smallcar_keil.uvoptx    # Keil 选项文件
    └─ RTE/Device/...          # CMSIS/Startup/System 文件
```

实际开发/编译主要使用 `smallcar_keil` 目录。

---

## 2. 硬件组成

- **主控 MCU**：STM32F103C8T6
- **电机驱动**：TB6612FNG
  - 左侧两轮并联为“左轮”；右侧两轮并联为“右轮”
- **电机**：4× 直流电机
- **遥控器**：PS2 无线手柄（须支持模拟模式）
- **舵机**：2× 9g/12g 舵机（如 SG90/MG90S），组成摄像头云台：
  - 舵机 1：水平 Yaw
  - 舵机 2：俯仰 Pitch
- **电源建议**：
  - 电机电源（TB6612 VM）：如 7.4V/11.1V 电池
  - 逻辑电源（STM32、TB6612 VCC、PS2 接收端）：5V/3.3V
  - 舵机电源：单独 5V ≥2A 模块
  - **所有 GND 共地**

详细引脚定义见 `doc/pins.md`，PS2 键位与控制映射详见 `doc/ps2_keymap.md`。

---

## 3. 引脚概览（简要）

完整表格请看 `doc/pins.md`，这里给一个简要概览：

### 3.1 电机 + TB6612FNG

- STBY：PA3
- 左轮 PWM：PB0（TIM3_CH3）
- 右轮 PWM：PB1（TIM3_CH4）
- 左轮方向：PB12（AIN1）、PB13（AIN2）
- 右轮方向：PB14（BIN1）、PB15（BIN2）

### 3.2 PS2 无线手柄（GPIO SPI）

- ATT/SEL (CS)：PA4
- CLK：PA5
- DATA (DI)：PA6（上拉输入）
- CMD (DO)：PA7

### 3.3 双舵机云台

- 云台水平 Yaw：PA0（TIM2_CH1）
- 云台俯仰 Pitch：PA1（TIM2_CH2）

---

## 4. 开发环境

- IDE：Keil µVision 5
- 编译器：ARMCC V5.06 (ARM-ADS)
- 设备包：`Keil.STM32F1xx_DFP.2.4.0`
- 启动与系统：RTE 内自动生成的 `startup_stm32f10x_md.s`、`system_stm32f10x.c`
- 不使用 HAL，采用寄存器直接配置 GPIO、TIM3、TIM2 等外设。

打开工程：

1. 启动 Keil µVision。
2. 打开 `smallcar_keil/smallcar_keil.uvprojx`。
3. 确认 Target 设备为 `STM32F103C8`。
4. 点击 Build，编译工程；使用 ST-LINK 等下载到目标板。

---

## 5. 控制逻辑说明（当前版本）

> 详细的键位 → 控制映射表请参见 `doc/ps2_keymap.md`，这里给出整体思路和重点。

### 5.1 速度挡位（SELECT 三档）

- 使用 SELECT 作为速度档位切换键：
  - 默认：`speed_percent = 80`（中档，`speed_level = 1`）；
  - 每按一次：在 60% / 80% / 100% 三档之间循环。

### 5.2 小车运动：R1/R2 油门 + L1/L2 原地转 + 左右方向差速

- L1 / L2 原地转（优先级最高）：
  - L1：原地左转（左轮后退、右轮前进）；
  - L2：原地右转（左轮前进、右轮后退）。

- R1 / R2 前进/后退油门：
  - R1：前进，基础速度为 `+speed_percent`；
  - R2：后退，基础速度为 `-speed_percent`；
  - 都不按：小车停止（若未触发原地转）。

- 左右差速转弯（建立在 R1/R2 基础之上）：
  - 左转弯：R1/R2 + 左方向（D-Pad 左 或 左摇杆向左）；
  - 右转弯：R1/R2 + 右方向（D-Pad 右 或 左摇杆向右）；
  - M1 下左摇杆 X 轴偏移用于细腻控制转向强度；
  - 上/下方向键和左摇杆 Y 轴在当前方案中不参与运动控制。

### 5.3 云台控制：彩色键 + 右摇杆 + 回中

- 彩色键步进：
  - 方块：Yaw 向右步进；
  - 圆圈：Yaw 向左步进；
  - 三角：Pitch 低头步进；
  - 叉号：Pitch 抬头步进。

- 右摇杆微调（M1）：
  - 在模拟模式下（`Data[1] = 0x73`），右摇杆 RX/RY 超过阈值时对 Yaw/Pitch 做连续步进微调，方向为：
    - `RX < 0x70`：Yaw 向右；`RX > 0x90`：Yaw 向左；
    - `RY < 0x70`：Pitch 低头；`RY > 0x90`：Pitch 抬头。

- 云台回中：
  - START：任意模式下，将 Yaw/Pitch 重置为 90° 中位；
  - 右摇杆按下 R3：在 M1 模式下同样触发回中。

### 5.4 串口远程控制（预留接口）

- 主控在 `USART1` 上实现了一个简单的 ASCII 串口控制协议，可被上位机或 ESP32-CAM 网关使用：
  - 一行一条指令：`C,throttle,steer,yaw,pitch`；
  - `throttle/steer` 映射到小车油门/转向；
  - `yaw/pitch` 用于设置云台目标角度（或 `-1` 表示保持不变）。
- 当串口收到**最近的有效指令**时，会覆盖当前 PS2 控制的电机和云台输出；
- 协议与行为细节详见 `doc/remote_control.md`。

---

## 6. 安全行为与上电注意事项

- 上电后，如果 PS2 手柄处于数字模式 M0（`Data[1] = 0x41`），仅使用按键（方向键、L1/L2、R1/R2、彩色键等）控制，小车依然可以运动，但**所有摇杆模拟量（LX/LY/RX/RY）在代码中强制视为中位**，避免劣质手柄模拟值飘移导致乱动。
- 只有在模拟模式 M1（`Data[1] = 0x73`）下，才启用左摇杆 X 软转向、右摇杆云台微调以及 R3 云台回中。
- 方向键优先级高于摇杆，保证在任何时候按 D-Pad 都能立即得到确定动作（紧急停车/转向）。
- 舵机供电建议使用独立 5V 大电流电源并与 STM32 共地，避免舵机大电流干扰 MCU 复位。

---

## 7. 使用步骤（快速上手）

1. 硬件按 `doc/pins.md` 接好：
   - STM32 ↔ TB6612 ↔ 电机
   - STM32 PA4~PA7 ↔ PS2 接收端
   - STM32 PA0/PA1 ↔ 两个舵机
   - 确保所有模块 GND 共地

2. 打开 Keil 工程 `smallcar_keil.uvprojx`，编译并下载到 STM32F103C8T6。

3. 打开 PS2 手柄，切换到 **模拟模式 M1**（`Data[1] = 0x73`，具体可在调试时查看 `Data[1]`）。在数字模式 M0 下，也可以用方向键 + L1/L2/R1/R2 驱动小车，只是摇杆模拟量被忽略。

4. 测试：
   - 使用 SELECT 按键切换速度挡位（60% / 80% / 100%）；
   - 用 R1/R2 测试前进/后退，用 L1/L2 测试原地左右旋转；
   - 用 R1/R2 + 左/右方向键测试差速转弯，在 M1 下松开方向键后，左摇杆 X 可做连续软转向；
   - 用彩色键（方块/圆圈/三角/叉号）步进式控制云台 Yaw/Pitch；
   - 在 M1 下，用右摇杆 RX/RY 做云台连续微调，并用 START 或 R3 测试云台一键回中。

---

## 8. 后续扩展方向（建议）

目前工程已具备较完整的底层驱动和遥控逻辑，可在此基础上继续扩展：

- 在小车上搭载树莓派：
  - 采集摄像头视频 + 麦克风音频
  - 通过 WebRTC 在局域网内实现实时视频/语音 + 浏览器遥控
- 低成本 ESP32-CAM 方案：
  - 使用 ESP32-CAM 直接采集摄像头画面，通过 Wi-Fi 推流到浏览器/手机或路由器（如 iStoreOS）；
  - 在 ESP32 上实现简单的控制协议，通过串口/Wi-Fi 将遥控指令转发给 STM32 小车主控；
- 通过串口连接上位机与 STM32：
  - 上位机（树莓派或 ESP32）作为“网关”，浏览器/手机控制 → 上位机 → 串口 → STM32 执行动作
- 补充文档：
  - 电源设计说明、电池选择、机械结构（云台固定方式等）

---

## 9. 许可协议

本项目采用 **MIT License** 开源协议发布。

- 你可以自由地使用、复制、修改、合并、出版、分发本项目代码，甚至用于商业用途；
- 唯一要求是在所有副本或重要部分中保留原始的版权声明和许可声明；
- 本项目代码按“现状（AS IS）”提供，不提供任何形式的担保，作者不对任何使用造成的损失负责。

详细条款请参见仓库根目录的 `LICENSE` 文件（MIT License 原文）。
