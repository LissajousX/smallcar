# STM32 PS2 无线遥控手柄接口文档

本接口文档基于提供的《PS2 接线说明文档》，重新整理并转换为适用于 **STM32（HAL 库）开发** 的技术手册。内容包括引脚定义、通信协议说明、时序要求、模式切换说明以及典型驱动流程示例。

---

## 1. PS2 接收机接口引脚定义

| 引脚编号 | 名称          | 方向        | 说明                   | STM32 建议连接       |
| ---- | ----------- | --------- | -------------------- | ---------------- |
| 1    | **DATA**    | PS2 → MCU | 控制器输出数据（开漏输出，需要上拉电阻） | `MISO`（带上拉 10kΩ） |
| 2    | **CMD**     | MCU → PS2 | MCU 发送命令             | `MOSI`           |
| 3    | **NC**      | -         | 未连接                  | -                |
| 4    | **GND**     | -         | 接地                   | GND              |
| 5    | **VCC**     | -         | 3.0V–5.0V 供电         | +3.3V（推荐）        |
| 6    | **ATT/SEL** | MCU → PS2 | 片选信号，低电平开始一帧通信       | GPIO 输出（推挽）      |
| 7    | **CLK**     | MCU → PS2 | SPI 时钟信号，空闲为高        | SPI CLK（模式 3）    |

---

## 2. 通信方式说明

PS2 手柄使用与 SPI 类似的通信方式，但具有以下特殊要求：

### 2.1 基本 SPI 模式

* **模式（CPOL = 1, CPHA = 1） → SPI Mode 3**
* **时钟空闲为高电平**
* **数据在下降沿输出，在上升沿采样**

### 2.2 时钟频率要求

* 推荐：**100 kHz – 250 kHz**
* 最大：**500 kHz**（部分控制器不兼容）

### 2.3 ATT（片选）要求

每发送一组字节前，必须：

1. 先将 **ATT 拉低**（选中控制器）
2. 完成本次数据帧通信后，将 **ATT 拉高**

类似 SPI 的 SS 片选，但 PS2 仅在 **每帧开始时**识别片选低电平。

---

## 3. 数据帧通信流程

典型读取手柄数据帧流程如下（固定格式）：

1. MCU 拉低 ATT
2. MCU 发送 0x01（帧头）
3. MCU 发送 0x42（查询命令）
4. MCU 发送 0x00（等待手柄回应）
5. 读取手柄 2 字节按键状态
6. 读取摇杆数据（4 字节）
7. MCU 拉高 ATT

---

## 4. 模式切换说明（红灯/绿灯模式）

手柄的 MODE 键可切换以下两种模式：

### 🔴 红灯模式（Digital Mode）

* 摇杆输出 **固定值（无效）**
* 仅按键数据有效

### 🟢 绿灯模式（Analog Mode）

* 摇杆返回模拟值
* 适合机器人、遥控车、机械臂等控制

开发 STM32 时，应确保手柄处于 **绿灯模式**（模拟模式）。

---

## 5. STM32 接线示例（HAL 库）

### 5.1 硬件 SPI 连接

```
PS2 DATA → PA6  (SPI1_MISO + 上拉电阻10k)
PS2 CMD  → PA7  (SPI1_MOSI)
PS2 CLK  → PA5  (SPI1_SCK)
PS2 ATT  → PA4  (GPIO_OUTPUT)
PS2 VCC  → 3.3V
PS2 GND  → GND
```

SPI 初始化使用：**Mode 3，100–250kHz**。

---

## 6. STM32 通信流程伪代码

```c
// 拉低 ATT
HAL_GPIO_WritePin(ATT_GPIO_Port, ATT_Pin, GPIO_PIN_RESET);

uint8_t tx[8] = {0x01, 0x42, 0x00};
uint8_t rx[8] = {0};

for (int i=0; i<8; i++) {
    HAL_SPI_TransmitReceive(&hspi1, &tx[i], &rx[i], 1, 10);
}

// 拉高 ATT
HAL_GPIO_WritePin(ATT_GPIO_Port, ATT_Pin, GPIO_PIN_SET);

// rx[3]-rx[6] 为摇杆数据
```

---

## 7. 常见问题与注意事项

### ✔ 手柄不回数据？

* ATT 片选 **必须在每帧开始拉低**
* DATA 必须加 10k 上拉
* SPI 必须设置为模式 3
* 时钟频率不要超过 500kHz

### ✔ STM32 用 5V 供电可以吗？

可以，但**推荐 3.3V 供电**以保护 STM32。

---

## 8. 总结

本接口文档对 PS2 无线手柄与 STM32 的通信方式做了完整整理，适用于机器人、遥控设备、机械臂等应用。本说明包含：

* 引脚说明
* SPI 时序说明
* ATT 用法
* 模式切换
* 驱动流程与示例
