# PS2 手柄键位与控制映射

> 本文描述当前 smallcar 工程中 PS2 手柄各键在两种模式（M0/M1）下的最终控制方案。

## 1. 模式标识

- M0（数字模式）：`Data[1] = 0x41`
- M1（模拟模式）：`Data[1] = 0x73`

代码中使用 `Data[1]` 区分两种模式，保证 **按键操作逻辑一致，M1 额外启用模拟轴增强控制**。

---

## 2. 小车运动控制

### 2.1 概览

| 功能             | 按键 / 摇杆                          | 模式 | 说明 |
|------------------|---------------------------------------|------|------|
| 前进油门         | R1                                   | M0/M1 | 作为前进油门，速度约为当前挡位 `+speed_percent` |
| 后退油门         | R2                                   | M0/M1 | 作为后退油门，速度约为 `-speed_percent` |
| 原地左转         | L1                                   | M0/M1 | 左轮后退、右轮前进，原地旋转 |
| 原地右转         | L2                                   | M0/M1 | 左轮前进、右轮后退，原地旋转 |
| 左转弯           | R1/R2 + 左方向（← 或 左摇杆左）      | M0/M1 | 有前/后分量基础上，左轮减速、右轮全速，形成左弯 |
| 右转弯           | R1/R2 + 右方向（→ 或 左摇杆右）      | M0/M1 | 有前/后分量基础上，右轮减速、左轮全速，形成右弯 |
| 停车             | R1/R2 都未按下（且未触发原地转）     | M0/M1 | `base=0` 时电机停止 |

说明：

- **L1/L2 原地转优先级最高**：按下即原地旋转，忽略 R1/R2 和左右方向。
- **R1/R2 仅决定前进/后退基础速度**；左右方向由 D-Pad 左/右或左摇杆 X 决定弯道程度。
- 上/下方向键与左摇杆上下在当前方案中不参与小车运动（预留给未来功能）。

### 2.2 速度挡位（SELECT）

- 变量：`speed_percent`，当前生效速度百分比。
- 默认：`speed_percent = 80`，`speed_level = 1`（中档）。
- 每按一次 SELECT：在 60 / 80 / 100 三档间循环：

| 档位 level | speed_percent | 说明   |
|------------|----------------|--------|
| 0          | 60             | 慢速   |
| 1          | 80             | 中速（默认） |
| 2          | 100            | 最高速 |

通过 `select_now && !select_prev` 做按下边沿检测，只在“按下瞬间”切换挡位，长按不会连跳。

### 2.3 M0/M1 差异

- M0：
  - 左摇杆仅作为“方向键别名”，通过 `Data[3]/Data[4]` 中的方向 bit 提供 ←/→ 信息。
  - 不使用模拟轴数值，仅用左右方向的“有/无”。
- M1：
  - 在没有左右方向键按下时，使用左摇杆 X（LX）模拟值增强方向控制：
    - LX 左右偏离 0x80 超过死区（约 ±20）后，按比例映射到 `steer=-100..100`，实现软转向。

---

## 3. 云台控制

### 3.1 云台方向（彩色键）

| 控制对象 | 功能       | 按键             | 模式 | 说明 |
|----------|------------|------------------|------|------|
| Yaw      | 向左微调   | 方块 `PINK`      | M0/M1 | 每帧 Yaw 角度减 `SERVO_STEP_ANGLE`，限幅 `[YAW_MIN, YAW_MAX]` |
| Yaw      | 向右微调   | 圆圈 `RED`       | M0/M1 | 每帧 Yaw 角度加 `SERVO_STEP_ANGLE` |
| Pitch    | 抬头       | 三角 `GREEN`     | M0/M1 | 每帧 Pitch 角度加步进，限幅 `[PITCH_MIN, PITCH_MAX]` |
| Pitch    | 低头       | 叉号 `BLUE`      | M0/M1 | 每帧 Pitch 角度减步进 |

- 当前参数：
  - `SERVO_STEP_ANGLE = 2°`
  - `YAW_MIN/YAW_MAX` 默认 `30°/150°`（约 120° 行程）
  - `PITCH_MIN/PITCH_MAX` 默认 `45°/135°`（约 90° 行程）

### 3.2 云台回中

| 功能     | 按键              | 模式 | 说明 |
|----------|-------------------|------|------|
| 云台回中 | `START`           | M0/M1 | 将 Yaw/Pitch 设为 90°（中位） |
| 云台回中 | 右摇杆按下 `R3`  | M1    | 仅在模拟模式下有效，作用同 START |

### 3.3 云台右摇杆微调（仅 M1）

在 M1（`Data[1] = 0x73`）下，右摇杆模拟轴参与云台控制：

- `RX < 0x70`：Yaw 向左（每帧减步进）。
- `RX > 0x90`：Yaw 向右。
- `RY < 0x70`：Pitch 抬头。
- `RY > 0x90`：Pitch 低头。

彩色键与右摇杆可以叠加使用，右摇杆提供更平滑的手感，彩色键提供精确单步控制。

---

## 4. 模式与数据位速查表

### 4.1 模式标志位（Data[1]）

| 模式编号 | 说明                         | Data[1] |
|----------|------------------------------|---------|
| M0       | 上电默认（未按 ANALOG）     | 0x41    |
| M1       | 按一次 ANALOG 后的模拟模式  | 0x73    |

### 4.2 部分按键位（Data[3]/Data[4]）

- 按键未按下时：对应 bit 为 1（`0xFF`）。
- 按键按下时：对应 bit 变 0（如 `0xEF/0xBF/0x7F/0xDF` 等）。

（详细 bit 映射可参考 `ps2.c` 中的 `MASK` 表，以及下方“5. 实测按键与 Data[] 对照表”。）

## 5. 实测按键与 Data[] 对照表

> 以下为基于当前这只廉价 PS2 手柄，在 Keil 调试中记录的主要对照关系，不同手柄可能略有差异。

### 5.1 M0（数字模式：Data[1] = 0x41）

- 左侧方向键（Data[3]）：
  - 不按：`0xFF`
  - 上：`0xEF`
  - 下：`0xBF`
  - 左：`0x7F`
  - 右：`0xDF`

- 右侧彩色键（Data[4]）：
  - 不按：`0xFF`
  - 三角（上）：`0xEF`
  - 叉号（下）：`0xBF`
  - 方块（左）：`0x7F`
  - 圆圈（右）：`0xDF`

- 肩键（Data[4]）：
  - 不按：`0xFF`
  - L1：`0xFB`
  - R1：`0xF7`
  - L2：`0xFE`
  - R2：`0xFD`

- START / SELECT（Data[3]）：
  - START：不按 `0xFF`，按下 `0xF7`
  - SELECT：不按 `0xFF`，按下 `0xFE`

- 摇杆按下（L3/R3）：
  - 实测：M0 下没有检测到独立的 L3/R3 按下位（视为“无”）。

### 5.2 M1（模拟模式：Data[1] = 0x73）

- 数字按键（Data[3]/Data[4]）：
  - 切到 M1 后，方向键、彩色键、肩键、START/SELECT 的 bit 模式与 M0 相同。

- 摇杆按下（Data[3]）：
  - 右摇杆按下 R3：`0xFB`
  - 左摇杆按下 L3：`0xFD`

- 模拟轴（Data[5..8]）：
  - `Data[5]` = RX，`Data[6]` = RY，`Data[7]` = LX，`Data[8]` = LY
  - 中位附近典型值：`RX ≈ 0x7F`，`RY ≈ 0x80`，`LX ≈ 0x7F`，`LY ≈ 0x80`
  - 典型极限（随具体手柄略有变化）：
    - RX：左端接近 `0x00`，右端接近 `0xFF`
    - RY：上端接近 `0x00`，下端接近 `0xFF`
    - LX：左端接近 `0x00`，右端接近 `0xFF`
    - LY：上端接近 `0x00`，下端接近 `0xFF`

