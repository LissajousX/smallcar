# 四轮差速小车引脚定义文档

MCU：**STM32F103C8T6**  
时钟：默认 72MHz（`system_stm32f10x.c` 配置）  
工程：`smallcar_keil`

---

## 1. 电机驱动 TB6612FNG

TIM3 用作双路 PWM，PB0/PB1 为左右轮 PWM 输出，PB12~PB15 为方向控制，PA3 为 STBY。

### 1.1 TB6612 逻辑管脚连接

| 功能             | STM32 引脚 | 方向       | 说明                                     |
|------------------|-----------|------------|------------------------------------------|
| STBY             | PA3       | 推挽输出   | `GPIOA->BSRR = BS3` 使能驱动（高电平）  |
| PWMA（左轮）     | PB0       | AF 推挽    | `TIM3_CH3`，左侧两轮 PWM                 |
| PWMB（右轮）     | PB1       | AF 推挽    | `TIM3_CH4`，右侧两轮 PWM                 |
| AIN1（左方向1）  | PB12      | 推挽输出   | 与 AIN2 组合决定左轮前/后/刹车           |
| AIN2（左方向2）  | PB13      | 推挽输出   | 同上                                     |
| BIN1（右方向1）  | PB14      | 推挽输出   | 与 BIN2 组合决定右轮前/后/刹车           |
| BIN2（右方向2）  | PB15      | 推挽输出   | 同上                                     |

### 1.2 方向逻辑（在 `motor.c` 中）

- 左轮：  
  - 前进：AIN1 = 1，AIN2 = 0  
  - 后退：AIN1 = 0，AIN2 = 1
- 右轮：  
  - 前进：BIN1 = 1，BIN2 = 0  
  - 后退：BIN1 = 0，BIN2 = 1

PWM 占空比由 `Motor_SetLR(int16_t left, int16_t right)` 控制，范围 -100 ~ +100（带最小占空比约 20% 保护）。

---

## 2. PS2 无线手柄（GPIO 模拟 SPI）

使用 GPIO 方式 bit-bang，全部在 **A 口**：

| PS2 信号           | STM32 引脚 | 方向     | 说明                                       |
|--------------------|-----------|----------|--------------------------------------------|
| ATT / SEL (CS)     | PA4       | 推挽输出 | 片选，低电平开始一帧通讯                  |
| CLK                | PA5       | 推挽输出 | 时钟，Mode3 风格，代码中在低电平期间采样  |
| DATA (DI)          | PA6       | 上拉输入 | 从手柄读数据，外部需 10k 上拉（文档要求） |
| CMD (DO)           | PA7       | 推挽输出 | 向手柄发送命令                            |

说明：

- 初始化在 `PS2_GPIO_Init()` 中完成：  
  - PA4/PA5/PA7 配置为 50MHz 推挽输出；  
  - PA6 配置为上拉输入，并软件上拉。
- `PS2_Cmd()` 函数在下降沿输出、低电平期间采样输入，实现类似 SPI 的时序。

---

## 3. 双舵机云台（摄像头俯仰/左右）

使用 **TIM2** 两路 PWM 输出，频率 50Hz，脉宽约 0.6ms~2.4ms 对应大致 0°~180° 行程（适配 SG90 类舵机）。

| 功能              | STM32 引脚 | 定时器通道 | 方向         | 说明                          |
|-------------------|-----------|-----------|--------------|-------------------------------|
| 云台水平 Yaw      | PA0       | TIM2_CH1  | AF 推挽输出  | 舵机 1 信号，左右旋转         |
| 云台俯仰 Pitch    | PA1       | TIM2_CH2  | AF 推挽输出  | 舵机 2 信号，上下俯仰         |

在 `servo.c` 中：

- 时钟配置：  
  - `TIM2->PSC = 72 - 1;` → 1MHz 计数  
  - `TIM2->ARR = 20000 - 1;` → 周期 20ms（50Hz）
- 映射函数 `Servo_AngleToCCR(angle)`：  
  - 0° → CCR ≈ 600（约 0.6ms）  
  - 180° → CCR ≈ 2400（约 2.4ms）

在 `main.c` 中当前控制方式为：

- 初始化：`Servo_Init();`
- 云台控制规则（当前版本）：  
  - 彩色键：  
    - 方块：Yaw 向左步进；  
    - 圆圈：Yaw 向右步进；  
    - 三角：Pitch 抬头步进；  
    - 叉号：Pitch 低头步进；  
  - 右摇杆（仅在模拟模式 M1）：  
    - RX/RY 超过阈值（约 0x70/0x90）时，对应方向连续步进微调；  
  - 云台回中：  
    - START 任意模式下回中；  
    - 右摇杆按下 R3 在 M1 下也可回中。
- 小车控制规则（简要）：  
  - L1/L2 用于原地左右旋转；  
  - R1/R2 作为前进/后退油门；  
  - 左右方向键 + 左摇杆 X 控制差速转弯；  
  - 详细键位说明见 `doc/ps2_keymap.md`。

---

## 4. 预留串口（远程控制 / ESP32-CAM）

当前工程在固件中使用 **USART1** 作为远程控制串口，预留给上位机或 ESP32-CAM 使用：

| 功能        | STM32 引脚 | 方向         | 说明                            |
|-------------|-----------|--------------|---------------------------------|
| USART1_TX   | PA9       | AF 推挽输出  | 串口发送（连接到上位机/ESP32 RX） |
| USART1_RX   | PA10      | 上拉输入     | 串口接收（连接到上位机/ESP32 TX） |

串口参数：115200 8N1，详见 `doc/remote_control.md`。

---

## 5. 电源与共地注意事项（简要）

- **电机 + TB6612**：  
  - VM 接电机电源（如 7.4V/11.1V），GND 接车载大地。
- **逻辑电源（STM32 + PS2 接收端 + TB6612 VCC）**：  
  - 一般 5V 或 3.3V，根据板子而定。
- **舵机电源**：  
  - 建议单独 5V 大电流电源（≥2A），与 STM32 板 **GND 共地**。
- 所有模块（STM32、TB6612、PS2 接收、舵机、未来树莓派/ESP32-CAM）**必须共地**，否则控制信号会不稳定。
